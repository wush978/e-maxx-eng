<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
</head>
<body>
<!--?title The Inclusion-Exclusion Principle-->
<h1 id="the-inclusion-exclusion-principle">The Inclusion-Exclusion Principle</h1>
<p>The inclusion-exclusion principle is an important combinatorial way to compute the size of a set or the probability of complex events. It relates the sizes of individual sets with their union.</p>
<h2 id="statement">Statement</h2>
<h3 id="the-verbal-formula">The verbal formula</h3>
<p>The inclusion-exclusion principle can be expressed as follows:</p>
<p>To compute the size of a union of multiple sets, it is necessary to sum the sizes of these sets <strong>separately</strong>, and then subtract the sizes of all <strong>pairwise</strong> intersections of the sets, then add back the size of the intersections of <strong>triples</strong> of the sets, subtract the size of <strong>quadruples</strong> of the sets, and so on, up to the intersection of <strong>all</strong> sets.</p>
<h3 id="the-formulation-in-terms-of-sets">The formulation in terms of sets</h3>
<p>The above definition can be expressed mathematically as follows:</p>
<p><br /><span class="math display">$$\left| \bigcup_{i=1}^n A_i \right| = \sum_{i=1}^n|A_i| - \sum_{1\leq i&lt;j\leq n} |A_i \cap A_j| + \sum _{1\leq i&lt;j&lt;k\leq n}|A_i \cap A_j \cap A_k| - \cdots + (-1)^{n-1} | A_1 \cap \cdots \cap A_n |$$</span><br /></p>
<p>And in a more compact way:</p>
<p><br /><span class="math display">$$\left|\bigcup_{i=1}^n A_i \right| = \sum_{\emptyset \neq J\subseteq \\{1,2,\ldots ,n\\}} (-1)^{|J|-1}{\Biggl |}\bigcap_{j\in J}A_{j}{\Biggr |}$$</span><br /></p>
<h3 id="the-formulation-using-venn-diagrams">The formulation using Venn diagrams</h3>
<p>Let the diagram show three sets <span class="math inline"><em>A</em></span>, <span class="math inline"><em>B</em></span> and <span class="math inline"><em>C</em></span>:</p>
<div class="figure">
<img src="&amp;imgroot&amp;/venn-inclusion-exclusion.png" title="Venn diagram" alt="Venn diagram" />
<p class="caption">Venn diagram</p>
</div>
<p>Then the area of their union <span class="math inline"><em>A</em> ∪ <em>B</em> ∪ <em>C</em></span> is equal to the sum of the areas <span class="math inline"><em>A</em></span>, <span class="math inline"><em>B</em></span> and <span class="math inline"><em>C</em></span> less double-covered areas <span class="math inline"><em>A</em> ∩ <em>B</em></span>, <span class="math inline"><em>A</em> ∩ <em>C</em></span>, <span class="math inline"><em>B</em> ∩ <em>C</em></span>, but with the addition of the area covered by three sets <span class="math inline"><em>A</em> ∩ <em>B</em> ∩ <em>C</em></span>:</p>
<p><br /><span class="math display"><em>S</em>(<em>A</em> ∪ <em>B</em> ∪ <em>C</em>)=<em>S</em>(<em>A</em>)+<em>S</em>(<em>B</em>)+<em>S</em>(<em>C</em>)−<em>S</em>(<em>A</em> ∩ <em>B</em>)−<em>S</em>(<em>A</em> ∩ <em>C</em>)−<em>S</em>(<em>B</em> ∩ <em>C</em>)+<em>S</em>(<em>A</em> ∩ <em>B</em> ∩ <em>C</em>)</span><br /></p>
<p>It can also be generalized for an association of <span class="math inline"><em>n</em></span> sets.</p>
<h3 id="the-formulation-in-terms-of-probability-theory">The formulation in terms of probability theory</h3>
<p>If <span class="math inline"><em>A</em><sub><em>i</em></sub></span> <span class="math inline">(<em>i</em> = 1, 2...<em>n</em>)</span> are events and <span class="math inline">${\cal P}(A_i)$</span> the probability of an event from <span class="math inline"><em>A</em><sub><em>i</em></sub></span> to occur, then the probability of their union (i.e. the probability that at least one of the events occur) is equal to:</p>
<p><br /><span class="math display">$$\begin{eqnarray}
{\cal P} \left( \bigcup_{i=1}^n A_i \right) &amp;=&amp; \sum_{i=1}^n{\cal P}(A_i)\ - \sum_{1\leq i&lt;j\leq n} {\cal P}(A_i \cap A_j)\  + \\\\\\
&amp;+&amp; \sum _{1\leq i&lt;j&lt;k\leq n}{\cal P}(A_i \cap A_j \cap A_k) - \cdots + (-1)^{n-1} {\cal P}( A_1 \cap \cdots \cap A_n )
\end{eqnarray}$$</span><br /></p>
<p>And in a more compact way:</p>
<p><br /><span class="math display">$${\cal P} \left(\bigcup_{i=1}^n A_i \right) = \sum_{\emptyset \neq J\subseteq \\{1,2,\ldots ,n\\}} (-1)^{|J|-1}\ {\cal P}{\Biggl (}\bigcap_{j\in J}A_{j}{\Biggr )}$$</span><br /></p>
<h2 id="proof">Proof</h2>
<p>For the proof it is convenient to use the mathematical formulation in terms of set theory:</p>
<p><br /><span class="math display">$$\left|\bigcup_{i=1}^n A_i \right| = \sum_{\emptyset \neq J\subseteq \\{1,2,\ldots ,n\\}} (-1)^{|J|-1}{\Biggl |}\bigcap_{j\in J}A_{j}{\Biggr |}$$</span><br /></p>
<p>We want to prove that any element contained in at least one of the sets <span class="math inline"><em>A</em><sub><em>i</em></sub></span> will occur in the formula only once (note that elements which are not present in any of the sets <span class="math inline"><em>A</em><sub><em>i</em></sub></span> will never be considered on the right part of the formula).</p>
<p>Consider an element <span class="math inline"><em>x</em></span> occurring in <span class="math inline"><em>k</em> ≥ 1</span> sets <span class="math inline"><em>A</em><sub><em>i</em></sub></span>. We will show it is counted only once in the formula. Note that:</p>
<ul>
<li>in terms which <span class="math inline">|<em>J</em>|=1</span>, the item <span class="math inline"><em>x</em></span> will be counted <strong><span class="math inline">+ <em>k</em></span></strong> times;</li>
<li>in terms which <span class="math inline">|<em>J</em>|=2</span>, the item <span class="math inline"><em>x</em></span> will be counted <strong><span class="math inline">$-\ \binom{k}{2}$</span></strong> times - because it will be counted in those terms that include two of the <span class="math inline"><em>k</em></span> sets containing <span class="math inline"><em>x</em></span>;</li>
<li>in terms which <span class="math inline">|<em>J</em>|=3</span>, the item <span class="math inline"><em>x</em></span> will be counted <strong><span class="math inline">$+\ \binom{k}{3}$</span></strong> times;</li>
<li><span class="math inline">⋯</span></li>
<li>in terms which <span class="math inline">|<em>J</em>|=<em>k</em></span>, the item <span class="math inline"><em>x</em></span> will be counted <strong><span class="math inline">$(-1)^{k-1}\cdot \binom{k}{k}$</span></strong> times;</li>
<li>in terms which <span class="math inline">|<em>J</em>|&gt;<em>k</em></span>, the item <span class="math inline"><em>x</em></span> will be counted <strong>zero</strong> times;</li>
</ul>
<p>This leads us to the following sum of <a href="./combinatorics/binomial-coefficients.html">binomial coefficients</a>:</p>
<p><br /><span class="math display">$$ T = \binom{k}{1} - \binom{k}{2} + \binom{k}{3} - \cdots + (-1)^{i-1}\cdot \binom{k}{i} + \cdots + (-1)^{k-1}\cdot \binom{k}{k}$$</span><br /></p>
<p>This expression is very similar to the binomial expansion of <span class="math inline">(1 − <em>x</em>)<sup><em>k</em></sup></span>:</p>
<p><br /><span class="math display">$$ (1 - x)^k = \binom{k}{0} - \binom{k}{1} \cdot x + \binom{k}{2} \cdot x^2 - \binom{k}{3} \cdot x^3 + \cdots + (-1)^k\cdot \binom{k}{k} \cdot x^k $$</span><br /></p>
<p>When <span class="math inline"><em>x</em> = 1</span>, <span class="math inline">(1 − <em>x</em>)<sup><em>k</em></sup></span> looks a lot like <span class="math inline"><em>T</em></span>. However, the expression has an additional <span class="math inline">$\binom{k}{0} = 1$</span>, and it is multiplied by <span class="math inline">−1</span>. That leads us to <span class="math inline">(1 − 1)<sup><em>k</em></sup> = 1 − <em>T</em></span>. Therefore <span class="math inline"><em>T</em> = 1 − (1 − 1)<sup><em>k</em></sup> = 1</span>, what was required to prove. The element is counted only once.</p>
<h2 id="generalization-for-calculating-number-of-elements-in-exactly-r-sets">Generalization for calculating number of elements in exactly <span class="math inline"><em>r</em></span> sets</h2>
<p>Inclusion-exclusion principle can be rewritten to calculate number of elements which are present in zero sets:</p>
<p><br /><span class="math display">$$\left|\bigcap_{i=1}^n \overline{A_i}\right|=\sum_{m=0}^n (-1)^m \sum_{|X|=m} \left|\bigcap_{i\in X} A_{i}\right|$$</span><br /></p>
<p>Consider its generalization to calculate number of elements which are present in exactly <span class="math inline"><em>r</em></span> sets:</p>
<p><br /><span class="math display">$$\left|\bigcup_{|B|=r}\left[\bigcap_{i \in B} A_i \cap \bigcap_{j \not\in B} \overline{A_j}\right]\right|=\sum_{m=r}^n (-1)^{m-r}\dbinom{m}{r} \sum_{|X|=m} \left|\bigcap_{i \in X} A_{i}\right|$$</span><br /></p>
<p>To proove this formula, consider some particular <span class="math inline"><em>B</em></span>. Due to basic inclusion-exclusion principle we can say about it that:</p>
<p><br /><span class="math display">$$\left|\bigcap_{i \in B} A_i \cap \bigcap_{j \not \in B} \overline{A_j}\right|=\sum_{m=r}^{n} (-1)^{m-r} \sum_{\substack{|X|=m \newline B \subset X}}\left|\bigcap_{i\in X} A_{i}\right|$$</span><br /></p>
<p>The sets on the left side do not intersect for different <span class="math inline"><em>B</em></span>, thus we can sum them up directly. Also one should note that any set <span class="math inline"><em>X</em></span> will always have coefficient <span class="math inline">( − 1)<sup><em>m</em> − <em>r</em></sup></span> if it occurs and it will occur for exactly <span class="math inline">$\dbinom{m}{r}$</span> sets <span class="math inline"><em>B</em></span>.</p>
<h2 id="usage-when-solving-problems">Usage when solving problems</h2>
<p>The inclusion-exclusion principle is hard to understand without studying its applications.</p>
<p>First, we will look at three simplest tasks &quot;at paper&quot;, illustrating applications of the principle, and then consider more practical problems which are difficult to solve without inclusion-exclusion principle.</p>
<p>Tasks asking to &quot;find the <strong>number</strong> of ways&quot; are worth of note, as they sometimes lead to polynomial solutions, not necessarily exponential.</p>
<h3 id="a-simple-task-on-permutations">A simple task on permutations</h3>
<p>Task: count how many permutations of numbers from <span class="math inline">0</span> to <span class="math inline">9</span> exist such that the first element is greater than <span class="math inline">1</span> and the last one is less than <span class="math inline">8</span>.</p>
<p>Let's count the number of &quot;bad&quot; permutations, that is, permutations in which the first element is <span class="math inline">≤1</span> and/or the last is <span class="math inline">≥8</span>.</p>
<p>We will denote by <span class="math inline"><em>X</em></span> the set of permutations in which the first element is <span class="math inline">≤1</span> and <span class="math inline"><em>Y</em></span> the set of permutations in which the last element is <span class="math inline">≥8</span>. Then the number of &quot;bad&quot; permutations, as on the inclusion-exclusion formula, will be:</p>
<p><br /><span class="math display">|<em>X</em> ∪ <em>Y</em>|=|<em>X</em>|+|<em>Y</em>|−|<em>X</em> ∩ <em>Y</em>|</span><br /></p>
<p>After a simple combinatorial calculation, we will get to:</p>
<p><br /><span class="math display">2 ⋅ 9!+2 ⋅ 9!−2 ⋅ 2 ⋅ 8!</span><br /></p>
<p>The only thing left is to subtract this number from the total of <span class="math inline">10!</span> to get the number of &quot;good&quot; permutations.</p>
<h3 id="a-simple-task-on-0-1-2-sequences">A simple task on (0, 1, 2) sequences</h3>
<p>Task: count how many sequences of length <span class="math inline"><em>n</em></span> exist consisting only of numbers <span class="math inline">0, 1, 2</span> such that each number occurs <strong>at least once</strong>.</p>
<p>Again let us turn to the inverse problem, i.e. we calculate the number of sequences which do <strong>not</strong> contain <strong>at least one</strong> of the numbers.</p>
<p>Let's denote by <span class="math inline"><em>A</em><sub><em>i</em></sub>(<em>i</em> = 0, 1, 2)</span> the set of sequences in which <strong>at least</strong> <span class="math inline"><em>i</em></span> of the numbers do <strong>not</strong> occur. The formula of inclusion-exclusion on the number of &quot;bad&quot; sequences will be:</p>
<p><br /><span class="math display">|<em>A</em><sub>0</sub> ∪ <em>A</em><sub>1</sub> ∪ <em>A</em><sub>2</sub>|=|<em>A</em><sub>0</sub>|+|<em>A</em><sub>1</sub>|+|<em>A</em><sub>2</sub>|−|<em>A</em><sub>0</sub> ∩ <em>A</em><sub>1</sub>|−|<em>A</em><sub>0</sub> ∩ <em>A</em><sub>2</sub>|−|<em>A</em><sub>1</sub> ∩ <em>A</em><sub>2</sub>|+|<em>A</em><sub>0</sub> ∩ <em>A</em><sub>1</sub> ∩ <em>A</em><sub>2</sub>|</span><br /></p>
<ul>
<li>The size of each <span class="math inline"><em>A</em><sub><em>i</em></sub></span> is <span class="math inline">2<sup><em>n</em></sup></span>, as each sequence can only contain two of the digits.</li>
<li>The size of each pairwise intersection <span class="math inline"><em>A</em><sub><em>i</em></sub> ∩ <em>A</em><sub><em>j</em></sub></span> is equal to <span class="math inline">1</span>, as there will be only one digit to build the sequence.</li>
<li>The size of the intersection of all three sets is equal to <span class="math inline">0</span>, as there will be no digits to build the sequence.</li>
</ul>
<p>As we solved the inverse problem, we subtract it from the total of <span class="math inline">3<sup><em>n</em></sup></span> sequences:</p>
<p><br /><span class="math display">3<sup><em>n</em></sup> − (3 ⋅ 2<sup><em>n</em></sup> − 3 ⋅ 1 + 0)</span><br /></p>
<h3 id="the-number-of-integer-solutions-to-the-equation">The number of integer solutions to the equation</h3>
<p>Consider the following equation: <br /><span class="math display"><em>x</em><sub>1</sub> + <em>x</em><sub>2</sub> + <em>x</em><sub>3</sub> + <em>x</em><sub>4</sub> + <em>x</em><sub>5</sub> + <em>x</em><sub>6</sub> = 20</span><br /> where <span class="math inline">0 ≤ <em>x</em><sub><em>i</em></sub> ≤ 8(<em>i</em> = 1, 2, …6)</span>.</p>
<p>Task: count the number of solutions to the equation.</p>
<p>Forget the restriction on <span class="math inline"><em>x</em><sub><em>i</em></sub></span> for a moment and just count the number of nonnegative solutions to this equation. This is easily done using <a href="./combinatorics/binomial-coefficients.html">binomial coefficients</a>: we want to break a sequence of <span class="math inline">20</span> units into <span class="math inline">6</span> groups, which is the same as distributing <span class="math inline">5</span> &quot;walls&quot; over <span class="math inline">25</span> slots:</p>
<p><br /><span class="math display">$$N_0 = \binom{25}{5}$$</span><br /></p>
<p>We will now calculate the number of &quot;bad&quot; solutions with the inclusion-exclusion principle. The &quot;bad&quot; solutions will be those in which one or more <span class="math inline"><em>x</em><sub><em>i</em></sub></span> are greater than <span class="math inline">9</span>.</p>
<p>Denote by <span class="math inline"><em>A</em><sub><em>k</em></sub>(<em>k</em> = 1, 2…6)</span> the set of solutions where <span class="math inline"><em>x</em><sub><em>k</em></sub> ≥ 9</span>, and all other <span class="math inline"><em>x</em><sub><em>i</em></sub> ≥ 0(<em>i</em> ≠ <em>k</em>)</span> (they may be <span class="math inline">≥9</span> or not). To calculate the size of <span class="math inline"><em>A</em><sub><em>k</em></sub></span>, note that we have essentially the same combinatorial problem that was solved in the two paragraphs above, but now <span class="math inline">9</span> of the units are excluded from the slots and definitely belong to the first group. Thus:</p>
<p><br /><span class="math display">$$ | A_k | = \binom{16}{5} $$</span><br /></p>
<p>Similarly, the size of the intersection between sets <span class="math inline"><em>A</em><sub><em>k</em></sub></span> and <span class="math inline"><em>A</em><sub><em>p</em></sub></span> is equal to:</p>
<p><br /><span class="math display">$$ \left| A_k \cap A_p \right| = \binom{7}{5}$$</span><br /></p>
<p>The size of each intersection of three sets is zero, since <span class="math inline">20</span> units will not be enough for three or more variables greater than or equal to <span class="math inline">9</span>.</p>
<p>Combining all this into the formula of inclusions-exceptions and given that we solved the inverse problem, we finally get the answer:</p>
<p><br /><span class="math display">$$\binom{25}{5} - \left(\binom{6}{1} \cdot \binom{16}{5} - \binom{6}{2} \cdot \binom{7}{5}\right) $$</span><br /></p>
<h3 id="the-number-of-relatively-primes-in-a-given-interval">The number of relatively primes in a given interval</h3>
<p>Task: given two numbers <span class="math inline"><em>n</em></span> and <span class="math inline"><em>r</em></span>, count the number of integers in the interval <span class="math inline">[1; <em>r</em>]</span> that are relatively prime to n (their greatest common divisor is <span class="math inline">1</span>).</p>
<p>Let's solve the inverse problem - compute the number of not mutually primes with <span class="math inline"><em>n</em></span>.</p>
<p>We will denote the prime factors of <span class="math inline"><em>n</em></span> as <span class="math inline"><em>p</em><sub><em>i</em></sub>(<em>i</em> = 1⋯<em>k</em>)</span>.</p>
<p>How many numbers in the interval <span class="math inline">[1; <em>r</em>]</span> are divisible by <span class="math inline"><em>p</em><sub><em>i</em></sub></span>? The answer to this question is:</p>
<p><br /><span class="math display">$$ \left\lfloor \frac{ r }{ p_i } \right\rfloor $$</span><br /></p>
<p>However, if we simply sum these numbers, some numbers will be summarized several times (those that share multiple <span class="math inline"><em>p</em><sub><em>i</em></sub></span> as their factors). Therefore, it is necessary to use the inclusion-exclusion principle.</p>
<p>We will iterate over all <span class="math inline">2<sup><em>k</em></sup></span> subsets of <span class="math inline"><em>p</em><sub><em>i</em></sub></span>s, calculate their product and add or subtract the number of multiples of their product.</p>
<p>Here is a C++ implementation:</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">int</span> solve (<span class="dt">int</span> n, <span class="dt">int</span> r) {
    vector&lt;<span class="dt">int</span>&gt; p;
    <span class="kw">for</span> (<span class="dt">int</span> i=<span class="dv">2</span>; i*i&lt;=n; ++i)
        <span class="kw">if</span> (n % i == <span class="dv">0</span>) {
            p.push_back (i);
            <span class="kw">while</span> (n % i == <span class="dv">0</span>)
                n /= i;
        }
    <span class="kw">if</span> (n &gt; <span class="dv">1</span>)
        p.push_back (n);

    <span class="dt">int</span> sum = <span class="dv">0</span>;
    <span class="kw">for</span> (<span class="dt">int</span> msk=<span class="dv">1</span>; msk&lt;(<span class="dv">1</span>&lt;&lt;p.size()); ++msk) {
        <span class="dt">int</span> mult = <span class="dv">1</span>,
            bits = <span class="dv">0</span>;
        <span class="kw">for</span> (<span class="dt">int</span> i=<span class="dv">0</span>; i&lt;(<span class="dt">int</span>)p.size(); ++i)
            <span class="kw">if</span> (msk &amp; (<span class="dv">1</span>&lt;&lt;i)) {
                ++bits;
                mult *= p[i];
            }

        <span class="dt">int</span> cur = r / mult;
        <span class="kw">if</span> (bits % <span class="dv">2</span> == <span class="dv">1</span>)
            sum += cur;
        <span class="kw">else</span>
            sum -= cur;
    }

    <span class="kw">return</span> r - sum;
}</code></pre></div>
<p>Asymptotics of the solution is <span class="math inline">$O (\sqrt{n})$</span>.</p>
<h3 id="the-number-of-integers-in-a-given-interval-which-are-multiple-of-at-least-one-of-the-given-numbers">The number of integers in a given interval which are multiple of at least one of the given numbers</h3>
<p>Given <span class="math inline"><em>n</em></span> numbers <span class="math inline"><em>a</em><sub><em>i</em></sub></span> and number <span class="math inline"><em>r</em></span>. You want to count the number of integers in the interval <span class="math inline">[1; <em>r</em>]</span> that are multiple of at least one of the <span class="math inline"><em>a</em><sub><em>i</em></sub></span>.</p>
<p>The solution algorithm is almost identical to the one for previous task — construct the formula of inclusion-exclusion on the numbers <span class="math inline"><em>a</em><sub><em>i</em></sub></span>, i.e. each term in this formula is the number of numbers divisible by a given subset of numbers <span class="math inline"><em>a</em><sub><em>i</em></sub></span> (in other words, divisible by their <a href="./algebra/euclid-algorithm.html">least common multiple</a>).</p>
<p>So we will now iterate over all <span class="math inline">2<sup><em>n</em></sup></span> subsets of integers <span class="math inline"><em>a</em><sub><em>i</em></sub></span> with <span class="math inline"><em>O</em>(<em>n</em>log<em>r</em>)</span> operations to find their least common multiple, adding or subtracting the number of multiples of it in the interval. Asymptotics is <span class="math inline"><em>O</em>(2<sup><em>n</em></sup> ⋅ <em>n</em> ⋅ log<em>r</em>)</span>.</p>
<h3 id="the-number-of-strings-that-satisfy-a-given-pattern">The number of strings that satisfy a given pattern</h3>
<p>Consider <span class="math inline"><em>n</em></span> patterns of strings of the same length, consisting only of letters (<span class="math inline"><em>a</em>...<em>z</em></span>) or question marks. You're also given a number <span class="math inline"><em>k</em></span>. A string matches a pattern if it has the same length as the pattern, and at each position, either the corresponding characters are equal or the character in the pattern is a question mark. The task is to count the number of strings that match exactly <span class="math inline"><em>k</em></span> of the patterns (first problem) and at least <span class="math inline"><em>k</em></span> of the patterns (second problem).</p>
<p>Notice first that we can easily count the number of strings that satisfy at once all of the specified patterns. To do this, simply &quot;cross&quot; patterns: iterate though the positions (&quot;slots&quot;) and look at a position over all patterns. If all patterns have a question mark in this position, the character can be any letter from <span class="math inline"><em>a</em></span> to <span class="math inline"><em>z</em></span>. Otherwise, the character of this position is uniquely defined by the patterns that do not contain a question mark.</p>
<p>Learn now to solve the first version of the problem: when the string must satisfy exactly <span class="math inline"><em>k</em></span> of the patterns.</p>
<p>To solve it, iterate and fix a specific subset <span class="math inline"><em>X</em></span> from the set of patterns consisting of <span class="math inline"><em>k</em></span> patterns. Then we have to count the number of strings that satisfy this set of patterns, and only matches it, that is, they don't match any other pattern. We will use the inclusion-exclusion principle in a slightly different manner: we sum on all supersets <span class="math inline"><em>Y</em></span> (subsets from the original set of strings that cointain <span class="math inline"><em>X</em></span>), and either add to the current answer of subtract it from the number of strings:</p>
<p><br /><span class="math display"><em>a</em><em>n</em><em>s</em>(<em>X</em>)=∑<sub><em>Y</em> ⊇ <em>X</em></sub>(−1)<sup>|<em>Y</em>|−<em>k</em></sup> ⋅ <em>f</em>(<em>Y</em>)</span><br /></p>
<p>Where <span class="math inline"><em>f</em>(<em>Y</em>)</span> is the number of strings that match <span class="math inline"><em>Y</em></span> (at least <span class="math inline"><em>Y</em></span>).</p>
<p>(If you have a hard time figuring out this, you can try drawing Venn Diagrams.)</p>
<p>If we sum up on all <span class="math inline"><em>a</em><em>n</em><em>s</em>(<em>X</em>)</span>, we will get the final answer:</p>
<p><br /><span class="math display"><em>a</em><em>n</em><em>s</em> = ∑<sub><em>X</em>  :  |<em>X</em>|=<em>k</em></sub><em>a</em><em>n</em><em>s</em>(<em>X</em>)</span><br /></p>
<p>However, asymptotics of this solution is <span class="math inline"><em>O</em>(3<sup><em>k</em></sup> ⋅ <em>k</em>)</span>. To improve it, notice that different <span class="math inline"><em>a</em><em>n</em><em>s</em>(<em>X</em>)</span> computations very often share <span class="math inline"><em>Y</em></span> sets.</p>
<p>We will reverse the formula of inclusion-exclusion and sum in terms of <span class="math inline"><em>Y</em></span> sets. Now it becomes clear that the same set <span class="math inline"><em>Y</em></span> would be taken into account in the computation of <span class="math inline"><em>a</em><em>n</em><em>s</em>(<em>X</em>)</span> of <span class="math inline">$\binom{|Y|}{k}$</span> sets with the same sign <span class="math inline">( − 1)<sup>|<em>Y</em>|−<em>k</em></sup></span>.</p>
<p><br /><span class="math display">$$ ans = \sum_{Y ~ : ~ |Y| \ge k} (-1)^{|Y|-k} \cdot \binom{|Y|}{k} \cdot f(Y) $$</span><br /></p>
<p>Now our solution has asymptotics <span class="math inline"><em>O</em>(2<sup><em>k</em></sup> ⋅ <em>k</em>)</span>.</p>
<p>We will now solve the second version of the problem: find the number of strings that match <strong>at least</strong> <span class="math inline"><em>k</em></span> of the patterns.</p>
<p>Of course, we can just use the solution to the first version of the problem and add the answers for sets with size greater than <span class="math inline"><em>k</em></span>. However, you may notice that in this problem, a set |Y| is considered in the formula for all sets with size <span class="math inline">≥<em>k</em></span> which are contained in <span class="math inline"><em>Y</em></span>. That said, we can write the part of the expression that is being multiplied by <span class="math inline"><em>f</em>(<em>Y</em>)</span> as:</p>
<p><br /><span class="math display">$$ (-1)^{|Y|-k} \cdot \binom{|Y|}{k} + (-1)^{|Y|-k-1} \cdot \binom{|Y|}{k+1} + (-1)^{|Y|-k-2} \cdot \binom{|Y|}{k+2} + \cdots + (-1)^{|Y|-|Y|} \cdot \binom{|Y|}{|Y|} $$</span><br /></p>
<p>Looking at Graham's (Graham, Knuth, Patashnik. &quot;Concrete mathematics&quot; [1998] ), we see a well-known formula for <a href="./combinatorics/binomial-coefficients.html">binomial coefficients</a>:</p>
<p><br /><span class="math display">$$ \sum_{k=0}^m (-1)^k \cdot \binom{n}{k} = (-1)^m \cdot \binom{n-1}{m} $$</span><br /></p>
<p>Applying it here, we find that the entire sum of binomial coefficients is minimized:</p>
<p><br /><span class="math display">$$ (-1)^{|Y|-k} \cdot \binom{|Y|-1}{|Y|-k} $$</span><br /></p>
<p>Thus, for this task, we also obtained a solution with the asymptotics <span class="math inline"><em>O</em>(2<sup><em>k</em></sup> ⋅ <em>k</em>)</span>:</p>
<p><br /><span class="math display">$$ ans = \sum_{Y ~ : ~ |Y| \ge k} (-1)^{|Y|-k} \cdot \binom{|Y|-1}{|Y|-k} \cdot f(Y) $$</span><br /></p>
<h3 id="the-number-of-ways-of-going-from-a-cell-to-another">The number of ways of going from a cell to another</h3>
<p>There is a field <span class="math inline"><em>n</em> × <em>m</em></span>, and <span class="math inline"><em>k</em></span> of its cells are impassable walls. A robot is initially at the cell <span class="math inline">(1, 1)</span> (bottom left). The robot can only move right or up, and eventually it needs to get into the cell <span class="math inline">(<em>n</em>, <em>m</em>)</span>, avoiding all obstacles. You need to count the number of ways he can do it.</p>
<p>Assume that the sizes <span class="math inline"><em>n</em></span> and <span class="math inline"><em>m</em></span> are very large (say, <span class="math inline">10<sup>9</sup></span>), and the number <span class="math inline"><em>k</em></span> is small (around <span class="math inline">100</span>).</p>
<p>For now, sort the obstacles by their coordinate <span class="math inline"><em>x</em></span>, and in case of equality — coordinate <span class="math inline"><em>y</em></span>.</p>
<p>Also just learn how to solve a problem without obstacles: i.e. learn how to count the number of ways to get from one cell to another. In one axis, we need to go through <span class="math inline"><em>x</em></span> cells, and on the other, <span class="math inline"><em>y</em></span> cells. From simple combinatorics, we get a formula using <a href="./combinatorics/binomial-coefficients.html">binomial coefficients</a>:</p>
<p><br /><span class="math display">$$\binom{x+y}{x}$$</span><br /></p>
<p>Now to count the number of ways to get from one cell to another, avoiding all obstacles, you can use inclusion-exclusion to solve the inverse problem: count the number of ways to walk through the board stepping at a subset of obstacles (and subtract it from the total number of ways).</p>
<p>When iterating over a subset of the obstacles that we'll step, to count the number of ways to do this simply multiply the number of all paths from starting cell to the first of the selected obstacles, a first obstacle to the second, and so on, and then add or subtract this number from the answer, in accordance with the standard formula of inclusion-exclusion.</p>
<p>However, this will again be non-polynomial in complexity <span class="math inline"><em>O</em>(2<sup><em>k</em></sup> ⋅ <em>k</em>)</span>.</p>
<p>Here goes a polynomial solution:</p>
<p>We will use dynamic programming: let's compute the numbers <span class="math inline"><em>d</em>[<em>i</em>][<em>j</em>]</span> — the number of ways to get from the <span class="math inline"><em>i</em> − <em>t</em><em>h</em></span> point to <span class="math inline"><em>j</em> − <em>t</em><em>h</em></span>, without stepping on any other obstacle (except for <span class="math inline"><em>i</em></span> and <span class="math inline"><em>j</em></span>, of course). We will compute this number for all the obstacle cells, and also the starting and ending ones (all possible pairs of cells from these).</p>
<p>Let's forget for a second the obstacles and just count the number of paths from cell <span class="math inline"><em>i</em></span> to <span class="math inline"><em>j</em></span>. We need to consider some &quot;bad&quot; paths, the ones that pass through the obstacles, and subtract them from the total number of ways of going from <span class="math inline"><em>i</em></span> to <span class="math inline"><em>j</em></span>.</p>
<p>When considering an obstacle <span class="math inline"><em>t</em></span> between <span class="math inline"><em>i</em></span> and <span class="math inline"><em>j</em></span> (<span class="math inline"><em>i</em> &lt; <em>t</em> &lt; <em>j</em></span>), on which we can step, we see that the number of paths from <span class="math inline"><em>i</em></span> to <span class="math inline"><em>j</em></span> that pass through <span class="math inline"><em>t</em></span> which have <span class="math inline"><em>t</em></span> as the <strong>first obstacle between <span class="math inline"><em>i</em></span> and <span class="math inline"><em>j</em></span></strong>. We can compute that as: <span class="math inline"><em>d</em>[<em>i</em>][<em>t</em>]</span> multiplied by the number of arbitrary paths from <span class="math inline"><em>t</em></span> to <span class="math inline"><em>j</em></span>. We can count the number of &quot;bad&quot; ways summing this for all <span class="math inline"><em>t</em></span> between <span class="math inline"><em>i</em></span> and <span class="math inline"><em>j</em></span>.</p>
<p>We can compute <span class="math inline"><em>d</em>[<em>i</em>][<em>j</em>]</span> in <span class="math inline"><em>O</em>(<em>k</em>)</span> for <span class="math inline"><em>O</em>(<em>k</em><sup>2</sup>)</span> pairs, so this solution has complexity <span class="math inline"><em>O</em>(<em>k</em><sup>3</sup>)</span>.</p>
<h3 id="the-number-of-coprime-quadruples">The number of coprime quadruples</h3>
<p>You're given <span class="math inline"><em>n</em></span> numbers: <span class="math inline"><em>a</em><sub>1</sub>, <em>a</em><sub>2</sub>, …, <em>a</em><sub><em>n</em></sub></span>. You are required to count the number of ways to choose four numbers so that their combined greatest common divisor is equal to one.</p>
<p>We will solve the inverse problem — compute the number of &quot;bad&quot; quadruples, i.e. quadruples in which all numbers are divisible by a number <span class="math inline"><em>d</em> &gt; 1</span>.</p>
<p>We will use the inclusion-exclusion principle while summing over all possible groups of four numbers divisible by a divisor <span class="math inline"><em>d</em></span>.</p>
<p><br /><span class="math display"><em>a</em><em>n</em><em>s</em> = ∑<sub><em>d</em> ≥ 2</sub>(−1)<sup><em>d</em><em>e</em><em>g</em>(<em>d</em>)−1</sup> ⋅ <em>f</em>(<em>d</em>)</span><br /></p>
<p>where <span class="math inline"><em>d</em><em>e</em><em>g</em>(<em>d</em>)</span> is the number of primes in the factorization of the number <span class="math inline"><em>d</em></span> and <span class="math inline"><em>f</em>(<em>d</em>)</span> the number of quadruples divisible by <span class="math inline"><em>d</em></span>.</p>
<p>To calculate the function <span class="math inline"><em>f</em>(<em>d</em>)</span>, you just have to count the number of multiples of <span class="math inline"><em>d</em></span> (as mentioned on a previous task) and use <a href="./combinatorics/binomial-coefficients.html">binomial coefficients</a> to count the number of ways to choose four of them.</p>
<p>Thus, using the formula of inclusions-exclusions we sum the number of groups of four divisible by a prime number, then subtract the number of quadruples which are divisible by the product of two primes, add quadruples divisible by three primes, etc.</p>
<h3 id="the-number-of-harmonic-triplets">The number of harmonic triplets</h3>
<p>You are given a number <span class="math inline"><em>n</em> ≤ 10<sup>6</sup></span>. You are required to count the number of triples <span class="math inline">2 ≤ <em>a</em> &lt; <em>b</em> &lt; <em>c</em> ≤ <em>n</em></span> that satisfy one of the following conditions:</p>
<ul>
<li>or <span class="math inline">${\rm gcd}(a,b) = {\rm gcd}(a,c) = {\rm gcd}(b,c) = 1$</span>,</li>
<li>or <span class="math inline">${\rm gcd}(a,b) &gt; 1, {\rm gcd}(a,c) &gt; 1, {\rm gcd}(b,c) &gt; 1$</span>.</li>
</ul>
<p>First, go straight to the inverse problem — i.e. count the number of non-harmonic triples.</p>
<p>Second, note that any non-harmonic triplet is made of a pair of coprimes and a third number that is not coprime with at least one from the pair.</p>
<p>Thus, the number of non-harmonic triples that contain <span class="math inline"><em>i</em></span> is equal the number of integers from <span class="math inline">2</span> to <span class="math inline"><em>n</em></span> that are coprimes with <span class="math inline"><em>i</em></span> multiplied by the number of integers that are not coprime with <span class="math inline"><em>i</em></span>.</p>
<p>Either <span class="math inline"><em>g</em><em>c</em><em>d</em>(<em>a</em>, <em>b</em>)=1 ∧ <em>g</em><em>c</em><em>d</em>(<em>a</em>, <em>c</em>)&gt;1 ∧ <em>g</em><em>c</em><em>d</em>(<em>b</em>, <em>c</em>)&gt;1</span></p>
<p>or <span class="math inline"><em>g</em><em>c</em><em>d</em>(<em>a</em>, <em>b</em>)=1 ∧ <em>g</em><em>c</em><em>d</em>(<em>a</em>, <em>c</em>)=1 ∧ <em>g</em><em>c</em><em>d</em>(<em>b</em>, <em>c</em>)&gt;1</span></p>
<p>In both of these cases, it will be counted twice. The first case will be counted when <span class="math inline"><em>i</em> = <em>a</em></span> and when <span class="math inline"><em>i</em> = <em>b</em></span>. The second case will be counted when <span class="math inline"><em>i</em> = <em>b</em></span> and when <span class="math inline"><em>i</em> = <em>c</em></span>. Therefore, to compute the number of non-harmonic triples, we sum this calculation through all <span class="math inline"><em>i</em></span> from <span class="math inline">2</span> to <span class="math inline"><em>n</em></span> and divide it by <span class="math inline">2</span>.</p>
<p>Now all we have left to solve is to learn to count the number of coprimes to <span class="math inline"><em>i</em></span> in the interval <span class="math inline">[2; <em>n</em>]</span>. Although this problem has already been mentioned, the above solution is not suitable here — it would require the factorization of each of the integers from <span class="math inline">2</span> to <span class="math inline"><em>n</em></span>, and then iterating through all subsets of these primes.</p>
<p>A faster solution is possible with such modification of the sieve of Eratosthenes:</p>
<ol style="list-style-type: decimal">
<li>First, we find all numbers in the interval <span class="math inline">[2; <em>n</em>]</span> such that its simple factorization does not include a prime factor twice. We will also need to know, for these numbers, how many factors it includes.
<ul>
<li>To do this we will maintain an array <span class="math inline"><em>d</em><em>e</em><em>g</em>[<em>i</em>]</span> to store the number of primes in the factorization of <span class="math inline"><em>i</em></span>, and an array <span class="math inline"><em>g</em><em>o</em><em>o</em><em>d</em>[<em>i</em>]</span>, to mark either if <span class="math inline"><em>i</em></span> contains each factor at most twice (<span class="math inline"><em>g</em><em>o</em><em>o</em><em>d</em>[<em>i</em>]=1</span>) or not (<span class="math inline"><em>g</em><em>o</em><em>o</em><em>d</em>[<em>i</em>]=0</span>). When iterating from <span class="math inline">2</span> to <span class="math inline"><em>n</em></span>, if we reach a number that has <span class="math inline"><em>d</em><em>e</em><em>g</em></span> equal to <span class="math inline">0</span>, then it is a prime and its <span class="math inline"><em>d</em><em>e</em><em>g</em></span> is <span class="math inline">1</span>.</li>
<li>During the sieve of Eratosthenes, we will iterate <span class="math inline"><em>i</em></span> from <span class="math inline">2</span> to <span class="math inline"><em>n</em></span>. When processing a prime number we go through all of its multiples and increase their <span class="math inline"><em>d</em><em>e</em><em>g</em>[]</span>. If one of these multiples is multiple of the square of <span class="math inline"><em>i</em></span>, then we can put <span class="math inline"><em>g</em><em>o</em><em>o</em><em>d</em></span> as false.</li>
</ul></li>
<li>Second, we need to calculate the answer for all <span class="math inline"><em>i</em></span> from <span class="math inline">2</span> to <span class="math inline"><em>n</em></span>, i.e., the array <span class="math inline"><em>c</em><em>n</em><em>t</em>[]</span> — the number of integers not coprime with <span class="math inline"><em>i</em></span>.
<ul>
<li>To do this, remember how the formula of inclusion-exclusion works — actually here we implement the same concept, but with inverted logic: we iterate over a component (a product of primes from the factorization) and add or subtract its term on the formula of inclusion-exclusion of each of its multiples.</li>
<li>So, let's say we are processing a number <span class="math inline"><em>i</em></span> such that <span class="math inline"><em>g</em><em>o</em><em>o</em><em>d</em>[<em>i</em>]=<em>t</em><em>r</em><em>u</em><em>e</em></span>, i.e., it is involved in the formula of inclusion-exclusion. Iterate through all numbers that are multiples of <span class="math inline"><em>i</em></span>, and either add or subtract <span class="math inline">⌊<em>N</em>/<em>i</em>⌋</span> from their <span class="math inline"><em>c</em><em>n</em><em>t</em>[]</span> (the signal depends on <span class="math inline"><em>d</em><em>e</em><em>g</em>[<em>i</em>]</span>: if <span class="math inline"><em>d</em><em>e</em><em>g</em>[<em>i</em>]</span> is odd, then we must add, otherwise subtract).</li>
</ul></li>
</ol>
<p>Here's a C++ implementation:</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">int</span> n;
<span class="dt">bool</span> good[MAXN];
<span class="dt">int</span> deg[MAXN], cnt[MAXN];

<span class="dt">long</span> <span class="dt">long</span> solve() {
    memset (good, <span class="dv">1</span>, <span class="kw">sizeof</span> good);
    memset (deg, <span class="dv">0</span>, <span class="kw">sizeof</span> deg);
    memset (cnt, <span class="dv">0</span>, <span class="kw">sizeof</span> cnt);

    <span class="dt">long</span> <span class="dt">long</span> ans_bad = <span class="dv">0</span>;
    <span class="kw">for</span> (<span class="dt">int</span> i=<span class="dv">2</span>; i&lt;=n; ++i) {
        <span class="kw">if</span> (good[i]) {
            <span class="kw">if</span> (deg[i] == <span class="dv">0</span>)  deg[i] = <span class="dv">1</span>;
            <span class="kw">for</span> (<span class="dt">int</span> j=<span class="dv">1</span>; i*j&lt;=n; ++j) {
                <span class="kw">if</span> (j &gt; <span class="dv">1</span> &amp;&amp; deg[i] == <span class="dv">1</span>)
                    <span class="kw">if</span> (j % i == <span class="dv">0</span>)
                        good[i*j] = <span class="kw">false</span>;
                    <span class="kw">else</span>
                        ++deg[i*j];
                cnt[i*j] += (n / i) * (deg[i]%<span class="dv">2</span>==<span class="dv">1</span> ? <span class="dv">+1</span> : <span class="dv">-1</span>);
            }
        }
        ans_bad += (cnt[i] - <span class="dv">1</span>) * <span class="dv">1ll</span> * (n<span class="dv">-1</span> - cnt[i]);
    }

    <span class="kw">return</span> (n<span class="dv">-1</span>) * <span class="dv">1ll</span> * (n<span class="dv">-2</span>) * (n<span class="dv">-3</span>) / <span class="dv">6</span> - ans_bad / <span class="dv">2</span>;
}</code></pre></div>
<p>The asymptotics of our solution is <span class="math inline"><em>O</em>(<em>n</em>log<em>n</em>)</span>, as for almost every number up to <span class="math inline"><em>n</em></span> we make <span class="math inline"><em>n</em>/<em>i</em></span> iterations on the nested loop.</p>
<h3 id="the-number-of-permutations-without-fixed-points-derangements">The number of permutations without fixed points (derangements)</h3>
<p>Prove that the number of permutations of length <span class="math inline"><em>n</em></span> without fixed points (i.e. no number <span class="math inline"><em>i</em></span> is in position <span class="math inline"><em>i</em></span> - also called a derangement) is equal to the following number:</p>
<p><br /><span class="math display">$$n! - \binom{n}{1} \cdot (n-1)! + \binom{n}{2} \cdot (n-2)! - \binom{n}{3} \cdot (n-3)! + \cdots \pm \binom{n}{n} \cdot (n-n)! $$</span><br /></p>
<p>and approximately equal to:</p>
<p><br /><span class="math display">$$ \frac{ n! }{ e } $$</span><br /></p>
<p>(if you round this expression to the nearest whole number — you get exactly the number of permutations without fixed points)</p>
<p>Denote by <span class="math inline"><em>A</em><sub><em>k</em></sub></span> the set of permutations of length <span class="math inline"><em>n</em></span> with a fixed point at position <span class="math inline"><em>k</em></span> (<span class="math inline">1 ≤ <em>k</em> ≤ <em>n</em></span>) (i.e. element <span class="math inline"><em>k</em></span> is at position <span class="math inline"><em>k</em></span>).</p>
<p>We now use the formula of inclusion-exclusion to count the number of permutations with at least one fixed point. For this we need to learn to count sizes of an intersection of sets <span class="math inline"><em>A</em><sub><em>i</em></sub></span>, as follows:</p>
<p><br /><span class="math display">$$\begin{eqnarray}
\left| A_p \right| &amp;=&amp; (n-1)!\ , \\\\\\
\left| A_p \cap A_q \right| &amp;=&amp; (n-2)!\ , \\\\\\
\left| A_p \cap A_q \cap A_r \right| &amp;=&amp; (n-3)!\ , \\\\\\
\cdots ,
\end{eqnarray}$$</span><br /></p>
<p>because if we know that the number of fixed points is equal <span class="math inline"><em>x</em></span>, then we know the position of <span class="math inline"><em>x</em></span> elements of the permutation, and all other <span class="math inline">(<em>n</em> − <em>x</em>)</span> elements can be placed anywhere.</p>
<p>Substituting this into the formula of inclusion-exclusion, and given that the number of ways to choose a subset of size <span class="math inline"><em>x</em></span> from the set of <span class="math inline"><em>n</em></span> elements is equal to <span class="math inline">$\binom{n}{x}$</span>, we obtain a formula for the number of permutations with at least one fixed point:</p>
<p><br /><span class="math display">$$\binom{n}{1} \cdot (n-1)! - \binom{n}{2} \cdot (n-2)! + \binom{n}{3} \cdot (n-3)! - \cdots \pm \binom{n}{n} \cdot (n-n)! $$</span><br /></p>
<p>Then the number of permutations without fixed points is equal to:</p>
<p><br /><span class="math display">$$n! - \binom{n}{1} \cdot (n-1)! + \binom{n}{2} \cdot (n-2)! - \binom{n}{3} \cdot (n-3)! + \cdots \pm \binom{n}{n} \cdot (n-n)! $$</span><br /></p>
<p>Simplifying this expression, we obtain <strong>exact and approximate expressions for the number of permutations without fixed points</strong>:</p>
<p><br /><span class="math display">$$ n! \left( 1 - \frac{1}{1!} + \frac{1}{2!} - \frac{1}{3!} + \cdots \pm \frac{1}{n!} \right ) \approx \frac{n!}{e} $$</span><br /></p>
<p>(because the sum in brackets are the first <span class="math inline"><em>n</em> + 1</span> terms of the expansion in Taylor series <span class="math inline"><em>e</em><sup>−1</sup></span>)</p>
<p>It is worth noting that a similar problem can be solved this way: when you need the fixed points were not among the <span class="math inline"><em>m</em></span> first elements of permutations (and not among all, as we just solved). The formula obtained is as the given above accurate formula, but it will go up to the sum of <span class="math inline"><em>k</em></span>, instead of <span class="math inline"><em>n</em></span>.</p>
<h2 id="practice-problems">Practice Problems</h2>
<p>A list of tasks that can be solved using the principle of inclusions-exclusions:</p>
<ul>
<li><a href="http://uva.onlinejudge.org/index.php?option=onlinejudge&amp;page=show_problem&amp;problem=1266">UVA #10325 &quot;The Lottery&quot; [difficulty: low]</a></li>
<li><a href="http://uva.onlinejudge.org/index.php?option=com_onlinejudge&amp;Itemid=8&amp;page=show_problem&amp;problem=2906">UVA #11806 &quot;Cheerleaders&quot; [difficulty: low]</a></li>
<li><a href="http://www.topcoder.com/stat?c=problem_statement&amp;pm=10875">TopCoder SRM 477 &quot;CarelessSecretary&quot; [difficulty: low]</a></li>
<li><a href="http://community.topcoder.com/stat?c=problem_statement&amp;pm=6658&amp;rd=10068">TopCoder TCHS 16 &quot;Divisibility&quot; [difficulty: low]</a></li>
<li><a href="http://www.spoj.pl/problems/NGM2/">SPOJ #6285 NGM2 , &quot;Another Game With Numbers&quot; [difficulty: low]</a></li>
<li><a href="http://community.topcoder.com/stat?c=problem_statement&amp;pm=8470">TopCoder SRM 382 &quot;CharmingTicketsEasy&quot; [difficulty: medium]</a></li>
<li><a href="http://www.topcoder.com/stat?c=problem_statement&amp;pm=8307">TopCoder SRM 390 &quot;SetOfPatterns&quot; [difficulty: medium]</a></li>
<li><a href="http://community.topcoder.com/stat?c=problem_statement&amp;pm=2013">TopCoder SRM 176 &quot;Deranged&quot; [difficulty: medium]</a></li>
<li><a href="http://community.topcoder.com/stat?c=problem_statement&amp;pm=10702&amp;rd=14144&amp;rm=303184&amp;cr=22697599">TopCoder SRM 457 &quot;TheHexagonsDivOne&quot; [difficulty: medium]</a></li>
<li><a href="http://esci.ru/ttb/statement-62.htm">Test&gt;&gt;&gt;thebest &quot;HarmonicTriples&quot; (in Russian) [difficulty: medium]</a></li>
<li><a href="http://www.spoj.pl/problems/MSKYCODE/">SPOJ #4191 MSKYCODE &quot;Sky Code&quot; [difficulty: medium]</a></li>
<li><a href="http://www.spoj.pl/problems/SQFREE/">SPOJ #4168 SQFREE &quot;Square-free integers&quot; [difficulty: medium]</a></li>
<li><a href="http://www.codechef.com/JAN11/problems/COUNTREL/">CodeChef &quot;Count Relations&quot; [difficulty: medium]</a></li>
<li><a href="http://www.spoj.com/problems/KPRIMESB/">SPOJ - Almost Prime Numbers Again</a></li>
<li><a href="http://www.spoj.com/problems/IITKWPCH/">SPOJ - Find number of Pair of Friends</a></li>
<li><a href="http://www.spoj.com/problems/SUBSET/">SPOJ - Balanced Cow Subsets</a></li>
</ul>
</body>
</html>
